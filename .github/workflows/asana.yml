name: Manage Asana Task on Pull Request Events

on:
  pull_request:
    types: [opened, closed]
    branches:
      - dev

jobs:
  create_asana_task:
    if: ${{ github.event.action == 'opened' && github.base_ref == 'dev' && github.head_ref != 'dev' }}
    runs-on: ubuntu-latest

    outputs:
      asana_task_id: ${{ steps.create_asana_task.outputs.asana_task_id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Create Asana Task
      id: create_asana_task
      run: |
        pr_title="${{ github.event.pull_request.title }}"
        pr_url="${{ github.event.pull_request.html_url }}"
        pr_body="${{ github.event.pull_request.body }}"

        asana_task_id=$(curl -X POST https://app.asana.com/api/1.0/tasks \
          -H "Authorization: Bearer 2/1206370253774697/1207905742780138:8d2035b60ee02493ca800700970a18f6" \
          -H "Content-Type: application/json" \
          -d "{
                \"data\": {
                  \"workspace\": \"1203486548572199\",
                  \"projects\": [\"1207906053156776\"],
                  \"name\": \"$pr_title\",
                  \"notes\": \"Pull Request URL: $pr_url\n\n$pr_body\",
                  \"custom_fields\": {
                    \"1205222382328468\": \"1205222382328471\"
                  }
                }
              }" | jq -r .data.gid)

        echo "Asana Task ID: $asana_task_id"
        echo "::set-output name=asana_task_id::$asana_task_id"

    - name: Add GitHub Link to Asana Attachment
      run: |
        asana_task_id=${{ steps.create_asana_task.outputs.asana_task_id }}
        echo "Adding attachment to Asana Task ID: $asana_task_id"
        pr_title="${{ github.event.pull_request.title }}"
        curl -X POST https://app.asana.com/api/1.0/attachments \
          -H "Authorization: Bearer 2/1206370253774697/1207905742780138:8d2035b60ee02493ca800700970a18f6" \
          -F parent=$asana_task_id \
          -F resource_subtype=external \
          -F url=${{ github.event.pull_request.html_url }} \
          -F name="#${{ github.event.pull_request.number }} $pr_title"

  update_asana_task:
    needs: create_asana_task
    if: ${{ github.event.action == 'closed' && github.base_ref == 'dev' && github.head_ref != 'dev' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Update Asana Task
      run: |
        asana_task_id=${{ needs.create_asana_task.outputs.asana_task_id }}
        echo "Updating Asana Task ID: $asana_task_id"
        
        if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
          status="Pull Request has been merged."
          status_field="1205222382328469"
        else
          status="Pull Request has been closed."
          status_field="1205222382328469"
        fi

        curl -X PUT https://app.asana.com/api/1.0/tasks/$asana_task_id \
          -H "Authorization: Bearer 2/1206370253774697/1207905742780138:8d2035b60ee02493ca800700970a18f6" \
          -H "Content-Type: application/json" \
          -d "{
                \"data\": {
                  \"notes\": \"$status\",
                  \"custom_fields\": {
                    \"1205222382328468\": \"$status_field\"
                  }
                }
              }"
